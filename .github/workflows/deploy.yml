name: CI/CD - Deploy na Main

on:
  push:
    branches:
      - main

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Baixar o c√≥digo
      - name: ‚¨áÔ∏è Baixar o c√≥digo
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Instalar Docker Compose
      - name: üß© Instalar Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      # 3Ô∏è‚É£ Subir containers do Docker (para teste local no CI)
      - name: üê≥ Subir containers
        run: |
          docker-compose up -d

      # 4Ô∏è‚É£ Esperar o MySQL inicializar
      - name: ‚è±Ô∏è Esperar MySQL
        run: |
          echo "Aguardando MySQL iniciar..."
          sleep 15

      # 5Ô∏è‚É£ Rodar teste de conex√£o PHP + MySQL
      - name: üß™ Testar conex√£o MySQL
        run: |
          docker-compose exec -T app php /var/www/html/ci-test.php

      # 6Ô∏è‚É£ Derrubar containers ap√≥s o teste
      - name: üßπ Derrubar containers
        if: always()
        run: docker-compose down

      # 7Ô∏è‚É£ Fazer deploy no servidor (s√≥ se o teste acima passou)
      - name: üöÄ Deploy no Servidor via SSH
        if: success()
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.HOST_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "Iniciando deploy..."
            cd /home/root/avaliacao

            # Atualiza c√≥digo
            git pull origin main

            # Reinicia containers
            docker compose down
            docker compose up -d --build

            echo "‚úÖ Deploy finalizado com sucesso!"
