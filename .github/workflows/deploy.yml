# name: CI/CD - Deploy na Main

# on:
#   push:
#     branches:
#       - main

# jobs:
#   build-test-deploy:
#     runs-on: ubuntu-latest

#     steps:
#       # 1ï¸âƒ£ Baixar o cÃ³digo
#       - name: â¬‡ï¸ Baixar o cÃ³digo
#         uses: actions/checkout@v3

#       # 2ï¸âƒ£ Instalar Docker Compose
#       - name: ðŸ§© Instalar Docker Compose
#         run: |
#           sudo apt-get update -y
#           sudo apt-get install -y docker-compose

#       # 3ï¸âƒ£ Subir containers para teste
#       - name: ðŸ³ Subir containers
#         run: |
#           docker-compose up -d

#       # 4ï¸âƒ£ Esperar o MySQL iniciar
#       - name: â±ï¸ Esperar MySQL
#         run: |
#           echo "Aguardando MySQL iniciar..."
#           sleep 15

#       # 5ï¸âƒ£ Testar conexÃ£o PHP + MySQL
#       - name: ðŸ§ª Testar conexÃ£o MySQL
#         run: |
#           docker-compose exec -T app php /var/www/html/ci-test.php

#       # 6ï¸âƒ£ Derrubar containers apÃ³s o teste
#       - name: ðŸ§¹ Derrubar containers
#         if: always()
#         run: docker-compose down -v

#       # 7ï¸âƒ£ Fazer deploy no servidor via SSH (somente se o teste passou)
#       - name: ðŸš€ Deploy no Servidor via SSH
#         if: success()
#         uses: appleboy/ssh-action@v0.1.10
#         with:
#           host: ${{ secrets.HOST_IP }}
#           username: ${{ secrets.HOST_USERNAME }}
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           port: 22
#           timeout: 600s
#           command_timeout: 300s
#           script_stop: true
#           script: |
#             echo "ðŸš€ Iniciando deploy..."

#             cd /home/root/avaliacao

#             echo "ðŸ”„ Atualizando cÃ³digo..."
#             git fetch --all
#             git reset --hard origin/main

#             echo "ðŸ§¹ Derrubando containers antigos..."
#             docker compose down -v || true

#             echo "ðŸ³ Subindo containers..."
#             docker compose pull
#             docker compose up -d

#             echo "âœ… Deploy finalizado com sucesso!"


# name: Deploy PHP App to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout cÃ³digo
#       uses: actions/checkout@v3

#     - name: Configurar chave SSH
#       run: |
#         mkdir -p ~/.ssh
#         echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
#         chmod 600 ~/.ssh/id_rsa
#         ssh-keyscan -H ${{ secrets.HOST_IP }} >> ~/.ssh/known_hosts

#     - name: Copiar arquivos para o VPS
#       run: |
#         rsync -avz --exclude '.git' --exclude 'node_modules' -e "ssh -i ~/.ssh/id_rsa" ./ ${{ secrets.USERNAME }}@${{ secrets.HOST_IP }}:/home/root/avaliacao

#     - name: Subir containers com Docker Compose
#       run: |
#         ssh -i ~/.ssh/id_rsa ${{ secrets.USERNAME }}@${{ secrets.HOST_IP }} << 'EOF'
#           cd /home/root/avaliacao
#           docker compose down
#           docker compose up -d --build
#         EOF


name: CI/CD - Build, Test & Deploy

on:
  push:
    branches:
      - main

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ Baixar o cÃ³digo
    - name: â¬‡ï¸ Checkout do cÃ³digo
      uses: actions/checkout@v3

    # 2ï¸âƒ£ Instalar Docker Compose
    - name: ðŸ§© Instalar Docker Compose
      run: |
        sudo apt-get update -y
        sudo apt-get install -y docker-compose

    # 3ï¸âƒ£ Subir containers para teste
    - name: ðŸ³ Subir containers
      run: docker-compose up -d

    # 4ï¸âƒ£ Esperar o MySQL iniciar
    - name: â±ï¸ Esperar MySQL
      run: |
        echo "Aguardando MySQL iniciar..."
        sleep 15

    # 5ï¸âƒ£ Testar conexÃ£o PHP + MySQL
    - name: ðŸ§ª Testar conexÃ£o MySQL
      run: docker-compose exec -T app php /var/www/html/ci-test.php

    # 6ï¸âƒ£ Derrubar containers apÃ³s o teste
    - name: ðŸ§¹ Derrubar containers
      if: always()
      run: docker-compose down -v

    # 7ï¸âƒ£ Fazer deploy no servidor via SSH (somente se os testes passaram)
    - name: ðŸš€ Deploy no Servidor via SSH
      if: success()
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script_stop: true
        script: |
          echo "ðŸš€ Iniciando deploy..."

          cd /root/app

          echo "ðŸ§¹ Derrubando containers antigos..."
          docker compose down -v || true

          echo "ðŸ“¦ Atualizando cÃ³digo..."
          rm -rf /root/app/*
          mkdir -p /root/app

          echo "ðŸ“¤ Copiando novo cÃ³digo..."
          rsync -avz --exclude '.git' --exclude 'node_modules' ./ /root/app

          echo "ðŸ³ Subindo containers..."
          docker compose up -d --build

          echo "âœ… Deploy finalizado com sucesso!"
