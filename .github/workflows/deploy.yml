name: CI/CD - Deploy na Main

on:
  push:
    branches:
      - main

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Baixar o cÃ³digo
      - name: â¬‡ï¸ Baixar o cÃ³digo
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Instalar Docker Compose
      - name: ğŸ§© Instalar Docker Compose
        run: |
          sudo apt-get update -y
          sudo apt-get install -y docker-compose

      # 3ï¸âƒ£ Subir containers para teste
      - name: ğŸ³ Subir containers
        run: |
          docker-compose up -d

      # 4ï¸âƒ£ Esperar o MySQL iniciar
      - name: â±ï¸ Esperar MySQL
        run: |
          echo "Aguardando MySQL iniciar..."
          sleep 15

      # 5ï¸âƒ£ Testar conexÃ£o PHP + MySQL
      - name: ğŸ§ª Testar conexÃ£o MySQL
        run: |
          docker-compose exec -T app php /var/www/html/ci-test.php

      # 6ï¸âƒ£ Derrubar containers apÃ³s o teste
      - name: ğŸ§¹ Derrubar containers
        if: always()
        run: docker-compose down -v

      # 7ï¸âƒ£ Fazer deploy no servidor via SSH (somente se o teste passou)
      - name: ğŸš€ Deploy no Servidor via SSH
        if: success()
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.HOST_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 600
          command_timeout: 300
          script_stop: true
          script: |
            echo "ğŸš€ Iniciando deploy..."

            cd /home/root/avaliacao

            echo "ğŸ”„ Atualizando cÃ³digo..."
            git fetch --all
            git reset --hard origin/main

            echo "ğŸ§¹ Derrubando containers antigos..."
            docker compose down -v || true

            echo "ğŸ³ Subindo containers..."
            docker compose pull
            docker compose up -d

            echo "âœ… Deploy finalizado com sucesso!"
